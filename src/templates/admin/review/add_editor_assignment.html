{% extends "admin/core/base.html" %}
{% load foundation %}
{% block title %}Add Editor Assignment{% endblock title %}
{% block title-section %}Add Editor Assignment{% endblock %}
{% block title-sub %}#{{ article.pk }} / {{ article.correspondence_author.last_name }} / {{ article.safe_title }}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    {% include "elements/breadcrumbs/unassigned_base.html" %}
    {% if article %}<li><a href="{% url 'review_unassigned_article' article.pk %}">{{ article.safe_title }}</a></li>{% endif %}
    <li>Add Editor Assignment</li>
{% endblock breadcrumbs %}

{% block body %}
    <div class="large-12 columns">
        <form id="editor_assignment_form" method="POST">
            {% include "elements/forms/errors.html" with form=form %}
            {% csrf_token %}
            <div class="box">
                <div class="title-area">
                    <h2>Select Editor</h2>
                        <a href="{% if journal_settings.general.enable_one_click_access %}#{% else %}{% url 'core_add_user' %}?role=section-editor&return={{ request.path }}{% endif %}" class="button" data-open="editor"><i class="fa fa-plus">&nbsp;</i>Add New Editor</a>
                        <a href="{% url 'core_manager_enrol_users' %}" class="button" target="_blank"><i class="fa fa-users">&nbsp;</i>Enroll Existing User</a>
                </div>
                <div class="content">
                    <div class="callout primary">
                        <p><span class="fa fa-info-circle"></span>&nbsp;
                            {% blocktrans %}
                                You can select an editor using the radio 
                                buttons in the first column.
                            {% endblocktrans %}
                            {% blocktrans %}
                                If you cannot find the editor you want in 
                                this list you can use <b>Enroll Existing User</b> to 
                                search the database and give users the Editor 
                                role, or <b>Add New Editor</b> to create a new 
                                account for an editor (this process is silent, 
                                they will not receive an account creation 
                                email).
                            {% endblocktrans %}
                        </p>
                    </div>

                    <table class="small scroll" id="editors">
                        <thead>
                        <tr>
                            <th>Select</th>
                            <th>Name</th>
                            <th>Email Address</th>
                            <th>Type</th>
                            <th>Active Assignments</th>
                            <th>Interests</th>
                        </tr>
                        </thead>

                        <tbody>
                        {% for editor in editors %}
                            {% include "admin/elements/review/add_editor_table_custom_row.html" with editor_type_label='Editor' %}
                        {% endfor %}
                        {% for editor in section_editors %}
                            {% include "admin/elements/review/add_editor_table_custom_row.html" with editor_type_label='Section Editor' %}
                        {% endfor %}
                        {% if not editors and not section_editors %}
                            <tr>
                                <td>No suitable editors.</td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="row expanded">
                    <div class="large-12 columns">
                        <button type="submit" class="button success" name="add" id="add">Add Editor</button>
                        &nbsp;
                    </div>
                </div>
            </div>
            </div>        &nbsp;&nbsp;
        </form>
    </div>

    {% if journal_settings.general.enable_one_click_access %}
    <div class="reveal large" id="editor" data-reveal data-animation-in="slide-in-up"
     data-animation-out="slide-out-down">
        <div class="card">
            <div class="card-divider">
                <h4><i class="fa fa-plus">&nbsp;</i>Add New Editor</h4>
            </div>
            <div class="card-section">
                <button class="close-button" data-close aria-label="Close reveal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="content">
                    <p>This form allows you to quickly create a new editor without having to input a full user's data.</p>
                    <form method="POST">
                        {% include "elements/forms/errors.html" with form=new_editor_form %}
                        {% csrf_token %}
                        {{ new_editor_form|foundation }}
                        <button type="submit" class="button success" name="assign" id="assign">Add Editor</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if form.modal %}
        {% include "admin/elements/confirm_modal.html" with modal=form.modal form_id="editor_assignment_form" %}
    {% endif %}

{% endblock body %}

{% block js %}
    {% include "elements/datatables.html" with target="#editors" %}
    {% if form.modal %}
        {% include "admin/elements/open_modal.html" with target=form.modal.id %}
    {% endif %}
    {% include "elements/datatables.html" with target="#enrolluser" %}

    <script lang="javascript">
    function getQueryStrings()
    {
        let vars = [], hash;
        let hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(let i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1].split('#')[0];
        }
        return vars;
    }

    // populate the query box when ready
    $( document ).ready(function() {
        let urls = getQueryStrings();
        let user = urls["user"];
        let user_id = urls["id"];

        if (user !== '') {
            $('#editors').DataTable().search(decodeURIComponent(user)).draw();

            if (user_id !== '') {
                $("input[value=" + decodeURIComponent(user_id) + "]").attr('checked', 'checked');
            }
        }
    });
    </script>
{% endblock js %}