{% load files %}
{% load roles %}
{% load securitytags %}
{% load static %}
{% load render_string %}

<table class="scroll small">
    <tr style="text-align: left">
        <th>ID</th>
        <th>Label</th>
        <th>Filename</th>
        <th>Modified</th>
        <th>Edit</th>
        <th>Download</th>
        <th>Preview</th>
        <th>Figures</th>
    </tr>
    {% for galley in galleys %}
        {% can_view_file galley.file as can_view_file_flag %}
        {% can_edit_file galley.file article as can_edit_file_flag %}
        {% can_view_file_history galley.file article as can_view_file_history_flag %}
        {% user_has_role request 'typesetter' as user_is_typesetter %}
        <tr>
            <td>{{ galley.pk }}</td>
            <td>{{ galley.label }}</td>
            <td>{{ galley.file.original_filename|truncatechars:40 }}</td>
            <td>{{ galley.file.last_modified|date:"Y-m-d G:i" }}</td>
            <td>
              <a
                class="button small secondary no-bottom-margin"
                href="{% url 'typesetting_edit_galley' article.pk galley.pk %}?return={% url 'typesetting_assignment' assignment.pk %}"
              >
                <span class="fa fa-edit"></span>
                Edit
              </a>
            </td>
            <td>
              {% url 'typesetting_typesetter_download_file' assignment.pk galley.file.pk as download_href %}
              {% with href=download_href size="small" %}
                {% include "elements/a_download.html" %}
              {% endwith %}
            </td>
            <td>
              {% url 'typesetting_preview_galley' article_id=article.pk galley_id=galley.pk assignment_id=assignment.pk as preview_href %}
              {% with href=preview_href size="small" %}
                {% include "elements/a_preview.html" %}
              {% endwith %}
            </td>
            <td>
                {% if galley.file.mime_type in galley.mimetypes_with_figures and galley.has_missing_image_files %}
                    Missing Figures
                {% else %}
                    N/a
                {% endif %}
            </td>
        {% empty %}
        <tr>
            <td colspan="10">No typeset files have been uploaded.</td>
        </tr>
    {% endfor %}
</table>

{% if not disable_upload %}
  <div class="button-group no-bottom-margin flex justify-end">
    {% with label="Upload New Typeset File" %}
      {% include "elements/a_upload_modal_trigger.html" %}
    {% endwith %}
  </div>
{% endif %}
