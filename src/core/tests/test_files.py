import os
import shutil
from tempfile import NamedTemporaryFile

from django.urls import reverse
from django.urls.base import clear_script_prefix
from django.test import TestCase, Client, override_settings
from django.core.files.uploadedfile import SimpleUploadedFile
from django.conf import settings
from django.utils import timezone

from utils.testing import helpers
from utils.shared import clear_cache
from submission import models as submission_models
from core import files

TEST_PDF_TEXT = "hello, world"
TEST_PDF = b'%PDF-1.3\n%\xc4\xe5\xf2\xe5\xeb\xa7\xf3\xa0\xd0\xc4\xc6\n3 0 obj\n<< /Filter /FlateDecode /Length 222 >>\nstream\nx\x01\xad\x92\xcd\x8a\x021\x10\x84\xefy\x8aRWM\x0e\xc6\xceL\x92I\xae\x8a\x97\xbd-\x04\xf6\xa0\x9e\x06=\x08\n:\xef\x0fv\x1c\xfc\x19]\x16d\x97\x10\xe8NBU\xf1\xa5\x8f\xf8\xc2\x11\xc4\xcbE\x8f`\x0b\x9c6\xf8\xc6\x01\xd3ycP7\x97+BS\xe7W\xba\xb0m\xdf\x16\xde\x92\xa6\x80z\x8fY\x82\xcb\x1a\xacB\xb0yG+\xd2\x1e\xd3\x94\n\x18\xa4-dO!\xed\xb0H\xec\xf7WG\xd1:N\xd8\x9d\x88\xd5\xebG\xf3\xaa\xd2\xce\x97.\'@\'\xc1\x12\xb2?P\x08\x90\x83\x0f\x85\x92 \x87J\xac\x91>\xff5\xd4\x1d\x83\xf3Q\x07\x1b\xfck\x129\xfa\x9d\x85x\x9f~fa\x9eY\xb8\x90\t\xd9\xf8\xfa\x1b\xccb\xcc\x10&\x86)\xacd.\x0cc\xb9\x1e(\x85.\x97\xce,\x88wf\xa1"\xd2\x91\xca\xf2G\x08\xe26\x10g9\xe6\x87b\nendstream\nendobj\n1 0 obj\n<< /Type /Page /Parent 2 0 R /Resources 4 0 R /Contents 3 0 R /MediaBox [0 0 595.2 841.92]\n>>\nendobj\n4 0 obj\n<< /ProcSet [ /PDF /Text ] /ColorSpace << /Cs1 5 0 R >> /Font << /TT2 7 0 R\n>> >>\nendobj\n8 0 obj\n<< /N 3 /Alternate /DeviceRGB /Length 2612 /Filter /FlateDecode >>\nstream\nx\x01\x9d\x96wTS\xd9\x16\x87\xcf\xbd7\xbd\xd0\x12" %\xf4\x1az\t \xd2;H\x15\x04Q\x89I\x80P\x02\x86\x84&vD\x05F\x14\x11)VdT\xc0\x01G\x87"cE\x14\x0b\x83\x82b\xd7\t\xf2\x10P\xc6\xc1QDE\xe5\xdd\x8ck\t\xef\xad5\xf3\xde\x9a\xfd\xc7Y\xdf\xd9\xe7\xb7\xd7\xd9g\xef}\xd7\xba\x00P\xfc\x82\x04\xc2tX\x01\x804\xa1X\x14\xee\xeb\xc1\\\x12\x13\xcb\xc4\xf7\x02\x18\x10\x01\x0eX\x01\xc0\xe1ff\x04G\xf8D\x02\xd4\xfc\xbd=\x99\x99\xa8H\xc6\xb3\xf6\xee.\x80d\xbb\xdb,\xbfP&s\xd6\xff\x7f\x91"7C$\x06\x00\nE\xd56<~&\x17\xe5\x02\x94S\xb3\xc5\x192\xff\x04\xca\xf4\x95)2\x8612\x16\xa1\t\xa2\xac"\xe3\xc4\xafl\xf6\xa7\xe6+\xbb\xc9\x98\x97&\xe4\xa1\x1aY\xce\x19\xbc4\x9e\x8c\xbbP\xde\x9a%\xe1\xa3\x8c\x04\xa1\\\x98%\xe0g\xa3|\x07e\xbdTI\x9a\x00\xe5\xf7(\xd3\xd3\xf8\x9cL\x000\x14\x99_\xcc\xe7&\xa1l\x892E\x14\x19\xee\x89\xf2\x02\x00\x08\x94\xc49\xbcr\x0e\x8b\xf99h\x9e\x00x\xa6g\xe4\x8a\x04\x89Ib\xa6\x11\xd7\x98i\xe5\xe8\xc8f\xfa\xf1\xb3S\xf9b1+\x94\xc3M\xe1\x88xL\xcf\xf4\xb4\x0c\x8e0\x17\x80\xafo\x96E\x01%Ym\x99h\x91\xed\xad\x1c\xed\xedY\xd6\xe6h\xf9\xbf\xd9\xdf\x1e~S\xfd=\xc8z\xfbU\xf1&\xec\xcf\x9eA\x8c\x9eY\xdfl\xec\xac/\xbd\x16\x00\xf6$Z\x9b\x1d\xb3\xbe\x95U\x00\xb4m\x06@\xe5\xe1\xacO\xef \x00\xf2\x05\x00\xb4\xde\x9c\xf3\x1e\x86l^\x92\xc4\xe2\x0c\'\x0b\x8b\xec\xecls\x01\x9fk.+\xe87\xfb\x9f\x82o\xca\xbf\x869\xf7\x99\xcb\xee\xfbV;\xa6\x17?\x81#I\x153eE\xe5\xa6\xa7\xa6KD\xcc\xcc\x0c\x0e\x97\xcfd\xfd\xf7\x10\xff\xe3\xc09i\xcd\xc9\xc3,\x9c\x9f\xc0\x17\xf1\x85\xe8UQ\xe8\x94\t\x84\x89h\xbb\x85<\x81X\x90.d\n\x84\x7f\xd5\xe1\x7f\x186\'\x07\x19~\x9dk\x14hu_\x00}\x859P\xb8I\x07\xc8o=\x00C#\x03$n?z\x02}\xeb[\x101\n\xc8\xbe\xbch\xad\x91\xafs\x8f2z\xfe\xe7\xfa\x1f\x0b\\\x8an\xe1LA"S\xe6\xf6\x0c\x8fdr%\xa2,\x19\xa3\xdf\x84l\xc1\x02\x12\x90\x07t\xa0\n4\x81.0\x02,`\r\x1c\x803p\x03\xde \x00\x84\x80H\x10\x03\x96\x03.H\x02i@\x04\xb2A>\xd8\x00\nA1\xd8\x01v\x83jp\x00\xd4\x81z\xd0\x04N\x826p\x06\\\x04W\xc0\rp\x0b\x0c\x80G@\n\x86\xc1K0\x01\xde\x81i\x08\x82\xf0\x10\x15\xa2A\xaa\x90\x16\xa4\x0f\x99B\xd6\x10\x1bZ\x08yCAP8\x14\x03\xc5C\x89\x90\x10\x92@\xf9\xd0&\xa8\x18*\x83\xaa\xa1CP=\xf4#t\x1a\xba\x08]\x83\xfa\xa0\x07\xd0 4\x06\xfd\x01}\x84\x11\x98\x02\xd3a\r\xd8\x00\xb6\x80\xd9\xb0;\x1c\x08G\xc2\xcb\xe0Dx\x15\x9c\x07\x17\xc0\xdb\xe1J\xb8\x16>\x0e\xb7\xc2\x17\xe1\x1b\xf0\x00,\x85_\xc2\x93\x08@\xc8\x08\x03\xd1FX\x08\x1b\xf1DB\x90X$\x01\x11!k\x91"\xa4\x02\xa9E\x9a\x90\x0e\xa4\x1b\xb9\x8dH\x91q\xe4\x03\x06\x87\xa1a\x98\x18\x16\xc6\x19\xe3\x87Y\x8c\xe1bVa\xd6bJ0\xd5\x98c\x98VL\x17\xe66f\x103\x81\xf9\x82\xa5b\xd5\xb1\xa6X\'\xac?v\t6\x11\x9b\x8d-\xc4V`\x8f`[\xb0\x97\xb1\x03\xd8a\xec;\x1c\x0e\xc7\xc0\x19\xe2\x1cp~\xb8\x18\\2n5\xae\x04\xb7\x0f\xd7\x8c\xbb\x80\xeb\xc3\r\xe1&\xf1x\xbc*\xde\x14\xef\x82\x0f\xc1s\xf0b|!\xbe\n\x7f\x1c\x7f\x1e\xdf\x8f\x1f\xc6\xbf\'\x90\tZ\x04k\x82\x0f!\x96 $l$T\x10\x1a\x08\xe7\x08\xfd\x84\x11\xc24Q\x81\xa8Ot"\x86\x10y\xc4\\b)\xb1\x8e\xd8A\xbcI\x1c&N\x93\x14I\x86$\x17R$)\x99\xb4\x81TIj"]&=&\xbd!\x93\xc9:dGr\x18Y@^O\xae$\x9f _%\x0f\x92?P\x94(&\x14OJ\x1cEB\xd9N9J\xb9@y@yC\xa5R\r\xa8n\xd4X\xaa\x98\xba\x9dZO\xbdD}J}/G\x933\x97\xf3\x97\xe3\xc9\xad\x93\xab\x91k\x95\xeb\x97{%O\x94\xd7\x97w\x97_.\x9f\'_!\x7fJ\xfe\xa6\xfc\xb8\x02Q\xc1@\xc1S\x81\xa3\xb0V\xa1F\xe1\xb4\xc2=\x85IE\x9a\xa2\x95b\x88b\x9ab\x89b\x83\xe25\xc5Q%\xbc\x92\x81\x92\xb7\x12O\xa9@\xe9\xb0\xd2%\xa5!\x1aB\xd3\xa5y\xd2\xb8\xb4M\xb4:\xdae\xda0\x1dG7\xa4\xfb\xd3\x93\xe9\xc5\xf4\x1f\xe8\xbd\xf4\te%e[\xe5(\xe5\x1c\xe5\x1a\xe5\xb3\xcaR\x06\xc20`\xf83R\x19\xa5\x8c\x93\x8c\xbb\x8c\x8f\xf34\xe6\xb9\xcf\xe3\xcf\xdb6\xafi^\xff\xbc)\x95\xf9*n*|\x95"\x95f\x95\x01\x95\x8f\xaaLUo\xd5\x14\xd5\x9d\xaam\xaaO\xd40j&jaj\xd9j\xfb\xd5.\xab\x8d\xcf\xa7\xcfw\x9e\xcf\x9d_4\xff\xe4\xfc\x87\xea\xb0\xba\x89z\xb8\xfaj\xf5\xc3\xea=\xea\x93\x1a\x9a\x1a\xbe\x1a\x19\x1aU\x1a\x974\xc65\x19\x9an\x9a\xc9\x9a\xe5\x9a\xe74\xc7\xb4hZ\x0b\xb5\x04Z\xe5Z\xe7\xb5^0\x95\x99\xee\xccTf%\xb3\x8b9\xa1\xad\xae\xed\xa7-\xd1>\xa4\xdd\xab=\xadc\xa8\xb3Xg\xa3N\xb3\xce\x13]\x92.[7A\xb7\\\xb7SwBOK/X/_\xafQ\xef\xa1>Q\x9f\xad\x9f\xa4\xbfG\xbf[\x7f\xca\xc0\xd0 \xda`\x8bA\x9b\xc1\xa8\xa1\x8a\xa1\xbfa\x9ea\xa3\xe1c#\xaa\x91\xab\xd1*\xa3Z\xa3;\xc68c\xb6q\x8a\xf1>\xe3[&\xb0\x89\x9dI\x92I\x8d\xc9MS\xd8\xd4\xdeT`\xba\xcf\xb4\xcf\x0ck\xe6h&4\xab5\xbb\xc7\xa2\xb0\xdcYY\xacF\xd6\xa09\xc3<\xc8|\xa3y\x9b\xf9+\x0b=\x8bX\x8b\x9d\x16\xdd\x16_,\xed,S-\xeb,\x1fY)Y\x05Xm\xb4\xea\xb0\xfa\xc3\xda\xc4\x9ak]c}\xc7\x86j\xe3c\xb3\xce\xa6\xdd\xe6\xb5\xad\xa9-\xdfv\xbf\xed};\x9a]\xb0\xdd\x16\xbbN\xbb\xcf\xf6\x0e\xf6"\xfb&\xfb1\x07=\x87x\x87\xbd\x0e\xf7\xd8tv(\xbb\x84}\xd5\x11\xeb\xe8\xe1\xb8\xce\xf1\x8c\xe3\x07\'{\'\xb1\xd3I\xa7\xdf\x9dY\xce)\xce\r\xce\xa3\x0b\x0c\x17\xf0\x17\xd4-\x18r\xd1q\xe1\xb8\x1cr\x91.d.\x8c_xp\xa1\xd4U\xdb\x95\xe3Z\xeb\xfa\xccM\xd7\x8d\xe7v\xc4m\xc4\xdd\xd8=\xd9\xfd\xb8\xfb+\x0fK\x0f\x91G\x8b\xc7\x94\xa7\x93\xe7\x1a\xcf\x0b^\x88\x97\xafW\x91W\xaf\xb7\x92\xf7b\xefj\xef\xa7>:>\x89>\x8d>\x13\xbev\xbe\xab}/\xf8a\xfd\x02\xfdv\xfa\xdd\xf3\xd7\xf0\xe7\xfa\xd7\xfbO\x048\x04\xac\t\xe8\n\xa4\x04F\x04V\x07>\x0b2\t\x12\x05u\x04\xc3\xc1\x01\xc1\xbb\x82\x1f/\xd2_$\\\xd4\x16\x02B\xfcCv\x85<\t5\x0c]\x15\xfas\x18.,4\xac&\xecy\xb8Ux~xw\x04-bEDC\xc4\xbbH\x8f\xc8\xd2\xc8G\x8b\x8d\x16K\x16wF\xc9G\xc5E\xd5GME{E\x97EK\x97X,Y\xb3\xe4F\x8cZ\x8c \xa6=\x16\x1f\x1b\x15{$vr\xa9\xf7\xd2\xddK\x87\xe3\xec\xe2\n\xe3\xee.3\\\x96\xb3\xec\xdar\xb5\xe5\xa9\xcb\xcf\xae\x90_\xc1Yq*\x1e\x1b\x1f\x1d\xdf\x10\xff\x89\x13\xc2\xa9\xe5L\xae\xf4_\xb9w\xe5\x04\xd7\x93\xbb\x87\xfb\x92\xe7\xc6+\xe7\x8d\xf1]\xf8e\xfc\x91\x04\x97\x84\xb2\x84\xd1D\x97\xc4]\x89cI\xaeI\x15I\xe3\x02OA\xb5\xe0u\xb2_\xf2\x81\xe4\xa9\x94\x90\x94\xa3)3\xa9\xd1\xa9\xcdi\x84\xb4\xf8\xb4\xd3B%a\x8a\xb0+]3=\'\xbd/\xc34\xa30C\xba\xcai\xd5\xeeU\x13\xa2@\xd1\x91L(sYf\xbb\x98\x8e\xfeL\xf5H\x8c$\x9b%\x83Y\x0b\xb3j\xb2\xdegGe\x9f\xcaQ\xcc\x11\xe6\xf4\xe4\x9a\xe4n\xcb\x1d\xc9\xf3\xc9\xfb~5f5wug\xbev\xfe\x86\xfc\xc15\xeek\x0e\xad\x85\xd6\xae\\\xdb\xb9Nw]\xc1\xba\xe1\xf5\xbe\xeb\x8fm mH\xd9\xf0\xcbF\xcb\x8de\x1b\xdfn\x8a\xde\xd4Q\xa0Q\xb0\xbe`h\xb3\xef\xe6\xc6B\xb9BQ\xe1\xbd-\xce[\x0el\xc5l\x15l\xed\xddf\xb3\xadj\xdb\x97"^\xd1\xf5b\xcb\xe2\x8a\xe2O%\xdc\x92\xeb\xdfY}W\xf9\xdd\xcc\xf6\x84\xed\xbd\xa5\xf6\xa5\xfbw\xe0v\x08w\xdc\xdd\xe9\xba\xf3X\x99bY^\xd9\xd0\xae\xe0]\xad\xe5\xcc\xf2\xa2\xf2\xb7\xbbW\xec\xbeVa[q`\x0fi\x8fd\x8f\xb42\xa8\xb2\xbdJ\xafjG\xd5\xa7\xea\xa4\xea\x81\x1a\x8f\x9a\xe6\xbd\xea{\xb7\xed\x9d\xda\xc7\xdb\xd7\xbf\xdfm\x7f\xd3\x01\x8d\x03\xc5\x07>\x1e\x14\x1c\xbc\x7f\xc8\xf7Pk\xadAm\xc5a\xdc\xe1\xac\xc3\xcf\xeb\xa2\xea\xba\xbfg\x7f_\x7fD\xedH\xf1\x91\xcfG\x85G\xa5\xc7\xc2\x8fu\xd5;\xd4\xd77\xa87\x946\xc2\x8d\x92\xc6\xb1\xe3q\xc7o\xfd\xe0\xf5C{\x13\xab\xe9P3\xa3\xb9\xf8\x048!9\xf1\xe2\xc7\xf8\x1f\xef\x9e\x0c<\xd9y\x8a}\xaa\xe9\'\xfd\x9f\xf6\xb6\xd0Z\x8aZ\xa1\xd6\xdc\xd6\x89\xb6\xa46i{L{\xdf\xe9\x80\xd3\x9d\x1d\xce\x1d-?\x9b\xff|\xf4\x8c\xf6\x99\x9a\xb3\xcagK\xcf\x91\xce\x15\x9c\x9b9\x9fw~\xf2B\xc6\x85\xf1\x8b\x89\x17\x87:Wt>\xba\xb4\xe4\xd2\x9d\xae\xb0\xae\xde\xcb\x81\x97\xaf^\xf1\xb9r\xa9\xdb\xbd\xfb\xfcU\x97\xabg\xae9];}\x9d}\xbd\xed\x86\xfd\x8d\xd6\x1e\xbb\x9e\x96_\xec~i\xe9\xb5\xefm\xbd\xe9p\xb3\xfd\x96\xe3\xad\x8e\xbe\x05}\xe7\xfa]\xfb/\xde\xf6\xba}\xe5\x8e\xff\x9d\x1b\x03\x8b\x06\xfa\xee.\xbe{\xff^\xdc=\xe9}\xde\xfd\xd1\x07\xa9\x0f^?\xccz8\xfdh\xfdc\xec\xe3\xa2\'\nO*\x9e\xaa?\xad\xfd\xd5\xf8\xd7f\xa9\xbd\xf4\xec\xa0\xd7`\xcf\xb3\x88g\x8f\x86\xb8C/\xff\x95\xf9\xafO\xc3\x05\xcf\xa9\xcf+F\xb4F\xeaG\xadG\xcf\x8c\xf9\x8c\xddz\xb1\xf4\xc5\xf0\xcb\x8c\x97\xd3\xe3\x85\xbf)\xfe\xb6\xf7\x95\xd1\xab\x9f~w\xfb\xbdgb\xc9\xc4\xf0k\xd1\xeb\x99?J\xde\xa8\xbe9\xfa\xd6\xf6m\xe7d\xe8\xe4\xd3wi\xef\xa6\xa7\x8a\xde\xab\xbe?\xf6\x81\xfd\xa1\xfbc\xf4\xc7\x91\xe9\xecO\xf8O\x95\x9f\x8d?w|\t\xfc\xf2x&mf\xe6\xdf\xf7\x84\xf3\xfb\nendstream\nendobj\n5 0 obj\n[ /ICCBased 8 0 R ]\nendobj\n2 0 obj\n<< /Type /Pages /MediaBox [0 0 612 792] /Count 1 /Kids [ 1 0 R ] >>\nendobj\n9 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n7 0 obj\n<< /Type /Font /Subtype /TrueType /BaseFont /AAAAAC+Aptos /FontDescriptor\n10 0 R /ToUnicode 11 0 R /FirstChar 33 /LastChar 41 /Widths [ 551 527 260\n552 286 203 721 334 561 ] >>\nendobj\n11 0 obj\n<< /Length 281 /Filter /FlateDecode >>\nstream\nx\x01]\x91\xcdj\xc30\x10\x84\xefz\x8a=\xa6\x87`\xc5M\xe2\x04\x8c\xa1\xa4\x04|\xe8\x0fu\xfb\x00\xb6\xb4\x0e\x82Z\x16\xb2|\xf0\xdbw\xa4\xa4)\xf40\x87oW#F\xa3\xecT?\xd7\xd6\x04\xca\xde\xfd\xa8\x1a\x0e\xd4\x1b\xab=O\xe3\xec\x15S\xc7\x17c\xc5&\'mT\xb8Q\x9a\xa9\xa1u"\x83\xb9Y\xa6\xc0Cm\xfb\x91\xcaR\x10e\x1f\xb0L\xc1/\xb4z\xd2c\xc7\x0fq\xf6\xe65{c/\xb4\xfa:5i\xd2\xcc\xce}\xf3\xc06\x90\x14UE\x9a{\\\xf7\xd2\xba\xd7v`\xca\x92u]k\xecMX\xd6p\xfd\x9d\xf8\\\x1c\x13\x12\xc1\xb1\xb9FR\xa3\xe6\xc9\xb5\x8a}k/,J)\xab\xf2|\xae\x04[\xfdou\xbc\x1a\xba\xfev2\xdfTe\x94\x94\xfbC%\xca<\x07B\xc0]\xc4G \x04T\x11\xb7@\x08\xd8G\xdc\x01!)\xf3\xb4\xdd\x03!\xa0\x8c\xdb\x02\x08IY\x14\x11\x0f@\x08\x98G<\x02!\\\xb5M9\x7f\x13\xc5\xc8\xb1\xda{\x15j\xf6\x1e-\xa4\xfeSA\xf1\xe1\xc6\xf2\xfd\x8b\xdc\xe8\xe2C\x93~\x00\xde_\x896\nendstream\nendobj\n10 0 obj\n<< /Type /FontDescriptor /FontName /AAAAAC+Aptos /Flags 4 /FontBBox [-500 -275 1182 1010]\n/ItalicAngle 0 /Ascent 939 /Descent -282 /CapHeight 657 /StemV 0 /XHeight\n476 /AvgWidth 561 /MaxWidth 1269 /FontFile2 12 0 R >>\nendobj\n12 0 obj\n<< /Length1 6144 /Length 3911 /Filter /FlateDecode >>\nstream\nx\x01\x8dX\rp\x1b\xd7q\xde\xbb\xc3\x1f\x01H\x02)\x8a\x94\x04\xd2w\xd0\x11\xd0\x0fH\x91"%\x8a\xa4d\x1b&ER$m\x89\xbf2\x8e\x94D\x80\xe0\xbf(\x89\x82\xf5\xff\xe3\xd0R\x143\xe7\xda\xf28\x8d\xeb\xc4m\x1dw\x1c\xabc\xa5\xe9An\x13\xd2\x93q\xed\xb4j\x9b\xa9\xe5\xb43\xedt\xa6\x936u\x9c\x8c\'\x99FI3\xd3\xb4\xe3\xa1\x84~\xfb\x0e\xa4~\xead\n\xdc\xdd{\xfb\xf3v\xf7\xed\xdb\xdd\xf7\xee\x8e\xa7O\x8c\x90\x8ffH\xa1\xaa\xd4\xe1\xe44\x89\xdf\xca\x7fD\xb3)u\xf2\xb8f\xc3\xca8\xda\xf7F\xa7\xc7\x0e\xdb\xb0c\x03\xd1\x8aKcSgFm\xb8p5\x91\xf2\xb7\xe3#\xc9a\x1b\xa6\x05\xb4\xb5\xe3@\xd8\xb0\xb4\x15m\xd9\xf8\xe1\xe3\xa7mx\xe57\xd0n\x98:\x9a\xca\xd1\x0b\x19]t8y:\xa7\x9f~\x00X;\x92<<\xc2\x04\xa2\xe2\x7f\xc7C\x9bN\x8f\xe4\xe8R\x9cH^\xc1\x94\xdf\xfa\x93@\xf5\xd2fr\x08.\x99\x02T\t\x94$?\xbe\xe2\x92\xc00]\x96\xaf\xfc\xf7\xfae\x7f?\xb8b\xe7\x7f\x91\xcf#\xd0\xff\xfa\xc6\x89O\xb9\xf3\xa3\xf1\xeam\x0b\xd2\xed\x9by\'<l\xa0\x8bdA\x86\x04"\xf7\xa5\xdb\x7f\x01\xe1\x91\x05\xe9\x7f~\x05z\x8e\xb0\xd4xc\xd9\xc1\xaa\xaczpKV=P\x99V\xf7W~I\x1d\xa8\xcc\xaa\xfd\x9b\xb3\xaa\xb1\xf9\xa6\x1a/\xcf\xaaOVd\xd5}\x157\xd5\xbehV\xed\xdd\xd8\xae\xf6l\xcc\xaa\xdd\x9b\xb2j\xd7\xa6kj\xe7FM\xdd\xbb\xa1Y\xdd\xb3\xe1\x9a\xfa\xc4\x86\xac\xfa\xf8\xfa\xac\xda\x11\xc9\xaa\xed\x91\xa8\xdaV6\xa6\xee.\xbb\xa9\xb6\x96e\xd5\x96pVm\x0e_Sw\xe9Y\xb5i]Vm\x0c\xddT\x1f\x0be\xd5X\xe8\x9a\xfa\xa8vS}D\xcb\xaa\x0fk_Rwj\x95\xea\x8e\x87\xd2j\xc3CY\xb5^\xcd\xaau\xea\x8c\xba\xbd4\xad\xd6\x96f\xd5m\xa57\xd5\xad%7\xd5\x9a\x92\xacZ]rM\xddR\x95V7\x97?\xacV\x94\xa7\xd5M\x1b\x0f\xaaa\xe8*[\x1b\\\xb3__\x17S\xd7)k\xd7\xec\x0f\xad}X\xd5v\xa2\xa3>4\xa6>\xb4qu\xd1\xfe\xd2\xe2\xacZR\x94U\x83\xdb\xd64\x0c\xac\xae-j\x18X\x1b\xeb\xe4~1\xf7W\xad\xd9Q4\xde\xbf\xb2\xbe\xa0/\xbf>\xd0W`\x04\x8ce\xf5\xfe>g\xbd\xdc\xe7\xc0\xed7V\xd4.\xef\xf3\xd5{\xfb\xdc\xf5\xae\xbe\xe5\x86\xd7p\x19d\xe4\xd5{\xfa\x14P=\x86l\x04H\x89\xc5\x9c\xd2\xbc\xf4"\xf5F;\xe6\xdc\xd9\xee\x0e\xcb\xd39`I\xb3V\xb8\x87\x9f\xb1\xae~\xcb5kQ_\xff@<#I/\x18\x97\x9f\x7f\x9eJ\x1b;\xac\x17{\xe2\xd7\x15B\xd7\xc8\xc8rSW<\xe3P^0\x1a)J\xd1(n\xfb/\xba98\x1a\x95\xee\xf9\x13\xfa|\x81[tx\x14:b4\x1a\xd1_\x02l\x98Yl\xfc]6`V\x93\xb3\x91\xffT\x90\xfd\xa7\xec\'\xca\x7fP>Q\xf6\xd6\xe2}\xe7\xab\xd9\x9f;\x8b\xa9\xc0\x86\xe9<=C\x87\xf1?E\xc3\xf8s\xff,M\xd3I\xea\xa1\x11:AS4\x06\x8eCx>E\x93\xf4\xcf\x94\xa4~JS/8\xc6\xe8\x1c\xb8\xbf@\xe3\x18q\x12\xcfc\x80?O\t:\nI\xe7\xe8\t\x8c\x8f\x0b\tIpN\x81z\x12\xd2/\x08I\xcc\xdf\rh\x02\xf2/Af\x1fd\x0eCJ\x9a\xba\xe8I:\x00\xfec\xb1\xf6\xaf\xbc\xf2{/?\xfb\x85\xcb\x9f\xbft\xf1\x99\x99\xcf=}\xe1\xfc\xb9\xb3gN\x9f:y\xe2\xf8S\xe9c\xd3G\x8f\x1c\x9e:491>6:2\x9c\x1aJ&\x06\x0f\x1e\xd8?\xd0o\xc4\x9f\xdc\xd7\xd7\xdb\xd3\xd5\xb9w\xcf\x13\x8fw\xb4\xb7\xednm\xd9\xa0\x06\xbcy\xe5R\xc6\xe7m\xd2\x9bF\xbc\x15\xe5\x94\xf1\xfa\xd0\xf5U\x94K\x96\xab\xc9r\x0b\xa4\xb57\xaaaQ\xe3\xa1\x8e\xeex\xf3\xae`(d\x04\xf5\x90\x15\xb3\x1c\xe1f\xbe\x93\xc3fj\x91`@\x04Fa,Dt\xf4\xe8\x1d]\xfdq\xad\xd9L\x88Q\xc0\xf4\xde\x07\xd9\xf4:\x96(h\xb9\x9e%7\xf5\xc6\xad\x96(\xf0\x82b\xc3\xad\x02\x06\xa3\r\xee~\x80\xdc\xb6H\xd65\x8b:Ms8CJ\x18bb\xc1\x8c$:\xce\xa6\xe7\x0c\xcc\xc4\xd0\xad\xa1\xa8\x1e\xd2\xe3#\x10\x95\xf1\x90?\xd4\x9bhB\xcf\xbf\xd8\x93\xb4Vh\xd0\xe6\x024\x84;\xf5\xa4>\'\xe5z\xfdqKK\x8c\x1a\xbb\xc1Mr\xd8\x12W\xcf\x1cm\xd3O\xdb\xfd\x84\xa5\xa54\xcdr\x85\xf5\xa1\xce\xb8\x19\xb2\xa4\x84\x1e\xcc\xc1\xddqxLJ\x06\xcd\x90\x1e\xd2\x0cc.\xfb~\ts\xeb!\xc8\x92\xa91\xa3K\xb3]\x99\x984\xdb\xd3\x1f\x9f\x0f\xa0\xb6\xce\xf6\xc6\xaf\xcb\x92\xdc\x94@\xaa\x94\x81\x16\x9f\xd7\x88b\x02\x8b\xccI42\x92Y4\x06\xa8C\xc2\xca\\\x97=\x82?8\x1f#\x9a\x11T\x87@\x088\x85Y\x08\x9c\xcd\x04\x9cD\xa99\xd9\xc6\x05\x04_&"\x14\xc5PWSs\x0e\x9b\x12[\x94\xe0\x00\xcec\xe3fl\xee\r9n\x0f(\x01\xa6\xbcC2*\xb1 \x1a\xe2\x07/a!c^g\xcc\x13\xcb\x8b\xf9\xe5e2\xd6\x82Q\xd7\x81y\x07\xbcy\x12\xbd\xed\x97\x96I\xc1\x0cdb\x06@\xcfI3\x99\xbcXp^H\xb2Q\xefH3\xe0d\xdc\x0c\x04\xe6\xd8db\xb6{\x04A\xa3=\xf1>4\xb9\x19\xf4\xf5\xc7\xdf\xf6\x13\xe4\x8b\'8\x1a\xf9WQ\xde\x9c\x91\xf7D\xf5\xbba\xdd\x15\xc7\x026g\xa4=\xd1\x04B\xbb\x03\xa0\x12n\xd6\x10\xd6V\xac\'\xce\xbc\x89 b>d\x18\xbb*\xca9\xba\xb4\xb8>\x12\xd4\x8dLa\xa19\xdd\x9c\t\x04\x9a:\xcc&\x04:bM\x04X&\xe9\x8a$\xa2f\xdc\xe2\x90\xe3@\xd3\x03\r\x08[%\xdc\x96\xd2[\x12`\xd1\x916\xb8\xda\x80J\xed\xd3\x12\xd6P"\x8a\xae\x16h1A\xd6RI\xe6\xa6\xa2\x8c\xac\x843\x92#,=B\x8f\xc0o.\xbf\xe5\xd5G\x1a-\x9f\xde\xb8Dy\x94\x1e\xb5).\xa6\xb8\xf5FK*\xb2\xbd\xde\xac7k\xab\'\xcc\x94>\x84\x08\x8cu\xc6\xc7\x82\xa3F\x12\xb2\xad\x98\x9e\xb4\x1czc0\xe3\xa0Fd\xd7j\tSj\xce\xd0\x9e(\xe6\xd6\x81\x18\xdc\x1b\xed\x1c@\x92\xb234\xd3\xdc\xa5eb\x8eH2\x95dxW\x08yo\xe6H\xfa\xae]\x9c\xb4\x8b#\x9a5\xd3\x8a%S\tp4\x1b\x82\xb9\xa2\x1c&\x98\xcdzR\x1bF\xf1\xc0t\xe1\xb9\x1e\x9d7\x87~\xd6\xd2\xdb\x1f7\xfd\xc3\xfa\xb0\x0e\x0f\xc7bf\x12\xd3\x0ej)#h\x1a)\xe1q\x98\x03\xd3\xa8\xa2\xdcy\xb7:\xe5\x8a\x93\xcc5 \x9c\x1a\xc5cN\xa3\xa1\x84>d#8;\x1f\xc4\x8d=\x88\x18\x05\xd7\xbd8\xbd\x9d\xd5\xc1\xd8v\xb6\x1a\xad\xd9\xae7\x0f\x83\x83\xef\xe4\xb0\xa5 \xe2B\xda0v,\x0e\x19\xea\x14u\xe372A\xc4\x12\x93\x865\x15\xc2\xcd\xc0\x0e\x8e\x1b\x86@\x17\x10\x00\\\xa65v?8\xbe\x04\xb6\x80\x8c`p\x847\xdb\xb1b9"\x1cy\xf1\x905\x19\xb4\xa6\x0c\x8e\x17\x9b%i\xcd\x0ci\xa6\x16\xd0\x1bt~\x888k\x05\xb55a9\xc3\xad\xd6L*\x89y\xa0&!\xf6\x80h\x07B\x8b\x0f!\x96!\xb0%a.F\x1c\x869"K\x9a\xac#X\xfb{D\xa2\xa4J\xbdP-\x87\xd9\x0b\xd6L\xa7\x960\xb4D\x02Xl\n\xa1\xa0f9\xd1j\xa3I\x0e..\xbb\x9d\xd0\x8f\xab\x13\xb5\x1fM\xd2\xec\xc1X\xe2\x04\nZn\xec\x00\xa3\xc9\x11=\x84\xe2\x0e\x9c!\xfc*\x96\x0f\xda\xdb\x11!q\x8b\x82\xa6\xa9\x9b\x96\x04\x13\xc3-`\x86\xf8\x88\xe5\x8a\xb4q\x83k:\xaa\'G\xb0\x88\xacOK\x8e\x88\xb1-0Wx\x87\xed\x0b6\xeb!\x03,r\x98\xfd\xce\x8eC\x9d\x1b\xe2G\xcaD4Z\x07\x90m\xcep\xbeY`j\xf5&\xaa\xd6\x01\x14\\G$\xb5/\x81mA\x0bh-\x9aX\xea$"\x99\x9d\xd0\xc6\x90\x01A6c\x1e2V\x8c\x87\x08\xb6\xe6p4s\xc0\x1d\xbe\x8b\x012l\x1d\x8d\xda\xcc\x1e!\x15\x96u\xc7\xadNV\xca\x97[\\\xe8\x1c\x8bZrq\x1d\x88\xbc@R7\xea\x07\xaa\x02\x16\x8a\x9d\xe7\x0c\xb7\xc1\xbd1\x84^\x90Gk\x96\x8c\xadL\x14\r{|\x1b\x0f\r\xe60\xb9a\xc0\x88\xb2\xcb\xbb&\xf6\x15\xdb\x04\x9fm\xaf\xad\xd4\xc5\xf2-\xbf\xb8\xf2\xc2\x96\'\x8c\x85\xb6\x1c\xb0\xc1&\xbby:\x8b2E\x1fF\xdbc`\x12\xcc\xb5\'\x80>T\xf1>\xc7\x97\x98H"\x078\xc2p;\xe4\x89\xad\x91\'\xc0+\x1fK"\xeb\x93zp.\xfb^\'jd\x02PB7\x0cV\x8f\x0ba\xc7#\x84h\xd3\x16\xcc\xee\x82d\xcfg\xba"\xa7\xc9V\xee\x0b[>p\xf1\x14l\x84\xfd\xf4\x86-\\\x98\x14lf\x9a\xed8\xa8\x00J\xd8\xcbzr\xde\x9b\xcf\xbeG\x80\xe09\xe17\xe1:\x1e\xa0\x84\x9f\xe5\x85@\x92\xe6\xf2n$h\x8d\x1b\xd1a[\x98\xcbn\xda4TTT\xeeT\x978m\x0c \x1b\xf4\x90\x1bu\x0c\x1e@A\xd3\xac\x9e(6\x111\xb7g\xc5\x88\x08B\x9cK\x08G\xa5\xd4\xa2S\x0bb(\xd7\xa1"\xb2H\xdf-\xf1\x83\x90Z\xfanK\x06\xb8\xd4\xd3\xaf\xcb$y\xf4:n\xf2\xf4\xba\x8c,\xb9Q\xedQ\x83\xf5\xc02?\n\xbd\x99J\x0cc\xeb\xc3F\r/S]p\'\x1f\x95\xe0\x0f,4.\xac\xedI.M\xbdqg\xd0\xc1\x99\x85\x8c\xb2N\xd9K\x8a\xb4\x82_\x98a\x89~\n\x95\x90\xbde{\xd2\xc34s\x89\xc8\x8e\x14\x83\xd9\xdbHM\xf1<\x19\xf5@\xde\xff\x1dez\xfe\x7f\xca\x10\nb5\xad<a\x08W\xa3\x88\x87\r\xfb\xcd\xaa\x14{\x81\xdaY\x01\x8a\xablO\xa3\x9d\xa7\xe2\x84\xa3\x91\xd3\xa6\x99J\xe2\x84u`9g\xa8?\x92\x0f|\x01\xe6T\x8f\xa9\xd5\xe7\xe6\x06\xdf\x9c\xc7\xbc;Y;l\xc0\x84\x05\xd8\x1b\xe7\xe9\xfb\x10\x04"x| \x04\xe0\xc7\xf7\xed\xd0\xf6\x81\x18\xc0\xc4\xdfGA\xcb\xd9=\x9f\xcd\x12\x1c\x98\xe3\xb6]\x07\xffB\x9e\x88\xf3\x1cY$\x06\x0b\xe3q\xa7\xa2\x06z-|\'\xc0\xd5\xc2w.\x93|\xb9,\xf5?P\xf5s\xe2\xed5\xcd\xbb\x9f\xa8/\t\xe3\x8d^_\x92\xc8PF\xf2\xe30\xec\x08:\xa11\xa2\x05\xe0\xae\x06\xb1t\x11\xcc\x04\xb0\xd9\x90\x91\xdc\x91\x1c\x03"2\x80i6\x98\xa6O\xb7\xb7\x14\x9d\xcb\xff<\x0e\xa0$\x0e\x97d\xa0:\xdf\x8f\xb0.`\xe9M\xd3\xb3\xec\xb3)\x9e\x07\xf9\x97\x89\x01\x9c\xfcX\xe5eK-K\xc9\xa5\x83\xb7\xc9\xf25\xf1\xf9\x05\x0bh\xe5q\x1d\xda\x8c\xf5\xbdp\x83\xc3\rQ!\x8e\x13\xf7l\x87\x02\xc5\xa9x\xef&\xb9\x9a}\x0fGc\x08<~T\x143f\\\xf4\xdb\xa8Hi[\xdc\x83\xd8\xde\xf8\x05(aO\xdd\x803\x02\x96\x84\xd6\x19\t\xf1\x1dd\xd7\x89\x98\xb3\x90\x19G\xa3\x86}\xe4\xba\xc0\xb1qQ\xa4\xd4\xc5\xa8\xa6M\xe0\x9c\xd5$\xe1\xb4\x85\x8d\x12}\r\xd5\x00\xdc\x9e\x88(r&\x0e<\x13Il\xcd\xa8C\\w\x8c\xd58Ku\xf3\xe9\x18o\x00z@\x93v\xd2N\xfb\xb5H\xb7#\xae\x07{\x80#\x1c\xdf\x19\xac7\xf0^1\x97\xfdi\t\xd7+\xb8F\xc6&\x8f\xbb\xd7\xd4\xb4@>H\xa6V\x80\x17\r\xeb2\xa7\xa2#G\xd3\x05\x0e\xbb\xb8+\x92\xe3\xe2\x19\\\x8e\x9a\xa6\xcd\xc7gr\xbflv\xf4\xc0\t\xfc\xc6\xe6\xad\x0bza\xd3\xd2\xfb\xd7+\xd1\xdfF\xc6\xe6\xd4\xd4\x8bze\r\xea\xa7C\xec\nk\x9f~\x06\x87\x85&\xdd\xd2\xb4\xfd(\x89@\xb6\x96\x18\xa6\x89\xed\xd4\xd4\xf9\x9dj_\xdc~2I*/\xe1\x93\x01\x9fbr\xbc\xc1\x12\xbc\xa3\xdd\x05\xfd\x18\x8a\x19\xcde\xdf.\xe1\xd7\xa5%m\xe7\x16\xb5\xa5\xa1\x8d\xd5\x9a\x8b\xea\xac\xd4gj\xe3(\x93\x06\xf8).1\xbbL-\xe9\xb6~G$\xa7\xd4\xdco\xf6\xe3\xfd0d\x95\xb2\xe2\x9c\x1d\x00\x97\x97p\xd5\x16\x96\xbc\xc2\x96\x90r\x03\xe7\x86\xf34\xe9\xd8\x8e{\x82^\x97W\xd1\xcb\x8eI\x9a\x94\xff\x84^w\xfe\x15\xf9\xa4\xaf\x11\xc9m\xf8\x96Gx\xd7\xc2\xfb\x0c~~|\xb5*A\x1b\xa2<|\xe1\x93Q\xac\x9d\xe8y\xc8\r\xbc\xcdA4H_\xa3\x1fK\x05R\x954)]\x91\xbe\x83\xff\x8f1B|3Sn8\xdb1n\x05\xad\xa4\n\xaa\x8c\xad\xddT\xac\xad]\xef,sx\x0b\'\xbc\x8e@`si\xd9\xca\x95\x92\x9c&O\x1a\x1f>\xaa\x03\x7f]\x9d_\x83G4\xbf\xa0\xb8\xbej\xcb\xb1\xfcP~x]d\xdb\xd6\xda\x9a\xea\xa2U\x85.g(?$Ej\xb7\xd7\xd6n\xdb\x1a\xd1\xd7\xb9V\xe9\x8b\x14\xb7\xcb\xe5Vn\xdcYSVUUVV]}\xe71\xe5\x91\x85\xefJ#\x8e\x1d;\x1aj\xbb\xf7\xf5\x0eN\xff\xd13\x17_\xedl\xda\xbe\xce\xe1l\xff\xf4[?\xac,+\xab\xe4\xfb\xf7\x1d\xdf]\xf8u\xf7\xa1\x8a\xf2\xd6\xda\x1d{\xe3\x9d\x17f\xcf\x1f\xea\x1c\xde\x1a\xed\xd8\x067\xd0d\xf6\x96\xf2\x03\xfe\xe2B*\x95\xc6\x02\xcb\xbd\xe9e\x94^\xeb\xf3\xb8\xd3+\x03\xe4\x83\xbd\xd5\xd5|E\xab\xb64\xaf\x8b\xb0\x91leq~M\xbe\xbe\xde\xe5Z_]\xbb=?"\x8c,,\x92n\x9d\xfa\xe6\xe0\xc8\xdc\x85\xf1\xafV^\xfd\xc3\xbc\xado<q\xe8\x85\xf2\x8d\x97G.?\xfb\xb9\x82\xf4\xc7W\xdf\xfc\xb7c\x03{d\xff\xa7\xef\xbe\xd0j|q\xa4U:\xd5}\xe8\xdd?\xfd\xf3ws\x16|\xa0\xfc\x90\xd6\xc2\xfb\xa5\xb1\xe5\xc1"Z\xb1\x82T6\xc0\xd6\x1f\xad\xce\xaf\xaf,\xa8\xaf\xb9\xcf\x02\xf8\xc9\x1dzH\xae\x81\x015\xcbe)$\x8c\x90k_\xfb\xbb\xa1\xc1\xbf|\xf9o~$\xcb\xb7\xdb\xa5\x1d3\x13\xd3O+_W\x86\xff\xecNR.Tf\xcf\x9c}\xae\xe0\xf2O\xae|\xf9\xe3\x99_~\xb4bc\xde\xe0k\x89\x89\xd4\xd8\x97\xbbdc\xf6\xc5+X\xe5\xd7\x89\x94\x7f\x80\'\n\xa98\xe6\x0f(.wZ\xa2\xb4\x8f\xbc\xec\x03\xacZu\xd5\x96\xa70m1\xffU\xf9z\xfeV\xa1\xd2\x9d\xff\xfa\x9b\x15\x7f|\xf1\x8d+WK\xf7\xb4\x1d\xfe\xdd\ng\xe3\xed_\xef\x98\xf8\xce7n\xff\x8e|\xa0\xe5\xc8\xa3\xa9\x1d\xb7\xf7p\x94\xbd\x8c\xc7\x7fB\xb6\x9f\x96\x7f\xcbIioNj\xd5\x96$;\x15b\x0b\x8bjjVI\xf3\xa7\x9e\xde\xfcf\xa5Q\xd1\xf1|\xca\xe1^\x90\x06\x12\xb3\xc2?\xbft\x90\xf2\x11\xa2K\xa5\xc0\xb7W\xc31\xb9\x85\x89\xc2\xa4{\x16\x85c\x87W\x84\xc3\x86\x97\xc4\xb5\xaa\xb0\xa8H\xae\xba\xf2\xc1\xa1C\x1f\\y\xe9\xfbG\x8f~\xff\xa5\xa9\x99\xba\xba\x99\xa9\x89s\xb5\xb5\xe7\x02g>z\xf5\xb5\x8f\xcf\x9e\xfd\xf8\xb5W?:sy\xf0\xea\xe4\xd4[\xc9\xe4[S\x93W\x07\xd9^\xf8B\x9eU\xfe\x85\x96\xd3\xaa\x98/O\xf8\xc2\x95\x16F/y\xa2\x18\x9e\xa8Y\xc5z\xe0\x83?pm|\xe9Daq\xdb\x91nM\xf9\xf0\xcd\xc7G\xbf\x12i*\xbf\xdd\xcb\x92|D\xce9\xe5C\xcc\\\x8d\x05|\x8aK!\x8f\xc7\xe9\x94\\K>@.\xd8y\x90\x94jV\xae\xe4K\xd2\x15Ej\xbc\xf3\xbdo~\xf2\xd3\xf9\x9f\xff\xe4\x8d;\xdf\xb3~qK\xf9p\xe1\x96R\xb0\xf0\x0b%\x7f\xa1ZY\xb3\xf0\t$\xcf\xdc\xf9\x99\xf4u\xfa\x15\xbe\x11\x16|\x9b$\xc9\xe7p\x16\x88p\x85\xc0\xaa-=\xebkk\xb7\x17\xdf\x93U\xae\xb765\xc4\xf3|u\xed\xedu\xdbw7\x1d\xbb\xf3\xb3\x83k\x0f\xc6\xbcm\xdb\xb6\xb7\xee\xe9\x1a|.\x81L\x96\x90\x03v\xae\xbb`-=\xc6\xbf\xa6\xe8c\xd3\xc7\x8f>E\xf4\xbf\xdd1[\x19\nendstream\nendobj\n13 0 obj\n<< /Producer (macOS Version 15.5 \\(Build 24F74\\) Quartz PDFContext) /CreationDate\n(D:20250529135303Z00\'00\') /ModDate (D:20250529135303Z00\'00\') >>\nendobj\nxref\n0 14\n0000000000 65535 f \n0000000316 00000 n \n0000003269 00000 n \n0000000022 00000 n \n0000000425 00000 n \n0000003234 00000 n \n0000000000 00000 n \n0000003401 00000 n \n0000000522 00000 n \n0000003352 00000 n \n0000003947 00000 n \n0000003593 00000 n \n0000004181 00000 n \n0000008180 00000 n \ntrailer\n<< /Size 14 /Root 9 0 R /Info 13 0 R /ID [ <908446fc312c2528bc7f4b811d666e88>\n<908446fc312c2528bc7f4b811d666e88> ] >>\nstartxref\n8342\n%%EOF\n'

class TestFilesHandler(TestCase):

    def setUp(self):
        self.press = helpers.create_press()
        self.press.save()
        self.journal_one, self.journal_two = helpers.create_journals()

        self.regular_user = helpers.create_user("harrykim@voyager.com")
        self.regular_user.is_active = True
        self.regular_user.save()

        self.article_in_production = submission_models.Article.objects.create(
            owner=self.regular_user, title="A Test Article",
            abstract="An abstract",
            stage=submission_models.STAGE_TYPESETTING,
            journal=self.journal_one,
            date_accepted=timezone.now(),
        )
        self.pk_string = str(self.article_in_production.pk)
        self.request = helpers.Request()
        self.request.user = self.regular_user

        self.test_file_one = SimpleUploadedFile(
            "test.png",
            b"\x00\x01\x02\x03",
        )

        self.test_file_two = SimpleUploadedFile(
            "file.txt",
            b"content",
        )
        self.test_xml_file = SimpleUploadedFile(
            "test.xml",
            """
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20120330//EN" "http://jats.nlm.nih.gov/publishing/1.2/JATS-journalpublishing1.dtd">
            <article>test</article>
            """.strip().encode("utf-8"),
        )

        self.files = list()

    def tearDown(self):
        for file in self.files:
            os.unlink(
                os.path.join(
                    settings.BASE_DIR,
                    'files',
                    'articles',
                    self.pk_string,
                    file.uuid_filename,
                )
            )

    def test_save_file(self):
        helpers.create_test_file(self, self.test_file_one)

        expected_file_path = os.path.join(
            os.path.join(
                settings.BASE_DIR, 'files', 'articles', self.pk_string,
            )
        )

        file_check = os.path.exists(
            expected_file_path,
        )

        self.assertTrue(file_check)

    def test_overwrite_file(self):
        file_to_replace, path_parts = helpers.create_test_file(
            self,
            self.test_file_one,
        )

        files.overwrite_file(
            self.test_file_two,
            file_to_replace,
            path_parts=path_parts,
        )

        file_path = os.path.join(
            settings.BASE_DIR,
            'files',
            'articles',
            self.pk_string,
            file_to_replace.uuid_filename,
        )

        with open(file_path, 'rb') as file:
            content = file.read()
            self.assertEqual(content, b'content')

    @override_settings(URL_CONFIG='domain')
    def test_serve_any_file(self):

        file, path_parts = helpers.create_test_file(
            self,
            self.test_file_two,
        )

        clear_cache()
        clear_script_prefix()

        url = reverse(
            'article_file_download',
            kwargs={
                'identifier_type': 'id',
                'identifier': self.article_in_production.pk,
                'file_id': file.pk,
            }
        )

        self.client.force_login(self.regular_user)
        response = self.client.get(url)

        self.assertEqual(response.status_code, 200)

    def test_xml_to_text(self):
        with NamedTemporaryFile("wb") as f:
            f.write(self.test_xml_file.read())
            f.seek(0)
            parsed_text = files.jats_to_text(f.name).strip()

        expected = "test"

        self.assertEqual(parsed_text, expected)

    def test_pdf_to_text(self):
        with NamedTemporaryFile(suffix='.pdf') as f:
            f.write(TEST_PDF)
            f.flush()
            parsed_text = files.pdf_to_text(f.name).strip()  
        self.assertEqual(parsed_text, TEST_PDF_TEXT)


    def test_index_file(self):
        file_ = files.save_file_to_article(
            self.test_xml_file,
            article=self.article_in_production,
            owner=self.request.user,
            label="test-xml",
        )
        indexed = file_.index_full_text()

        self.assertTrue(indexed)

